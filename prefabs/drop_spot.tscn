[gd_scene load_steps=5 format=3 uid="uid://cdcpxpfojuaeq"]

[ext_resource type="Texture2D" uid="uid://31opkp4ms3cq" path="res://assets/images/backdrop_elements/border.png" id="1_mwg88"]
[ext_resource type="Texture2D" uid="uid://dkw1k3h357qhx" path="res://assets/images/backdrop_elements/border_hover.png" id="2_lx47d"]

[sub_resource type="GDScript" id="GDScript_5g2wd"]
resource_name = "drop_spot"
script/source = "extends Area2D

const snap_velocity = 15.0
const vertical_offset = 23
@onready var init_size = $CollisionShape2D.shape.size

var is_highlighted = false
var cards = []
var enemy_cards = []

func _ready() -> void:
	Global.drop_spots.append(self)

func empty_card_refs():
	for idx in range(cards.size()):
		cards[idx].queue_free()
	for idx in range(enemy_cards.size()):
		enemy_cards[idx].queue_free()
	cards = []
	enemy_cards = []

func _physics_process(delta: float) -> void:
	for idx in range(cards.size()):
		var desired_pos = global_position + init_size / 2 + Vector2(0.0, idx * vertical_offset)
		cards[idx].global_position = lerp(cards[idx].global_position + cards[idx].size / 2, desired_pos, snap_velocity * delta) - cards[idx].size / 2
	var guard: bool = Rect2($CollisionShape2D.global_position - $CollisionShape2D.shape.size / 2.0, $CollisionShape2D.shape.size).has_point(get_global_mouse_position())
	if guard != is_highlighted:
		_toggle_highlight()

func card_got_dropped(card) -> void:
	var guard: bool = Rect2($CollisionShape2D.global_position - $CollisionShape2D.shape.size / 2.0, $CollisionShape2D.shape.size).has_point(get_global_mouse_position())
	if guard:
		cards.append(card)
		card.drop_spotted()
		card.set_sprite_z_index(cards.size() - 1)
		card.get_parent().move_child(card, -1)
		card.turn_to_back()
		$CollisionShape2D.shape.size.y = init_size.y + cards.size() * vertical_offset
		$highlight.visible = false
		is_highlighted = false

func _toggle_highlight():
	if !Global.node_being_dragged or Global.node_being_dragged_is_player != 1:
		return
	if is_highlighted:
		$highlight.visible = false
		is_highlighted = false
	else:
		$highlight.visible = true
		is_highlighted = true
"

[sub_resource type="RectangleShape2D" id="RectangleShape2D_5g2wd"]
size = Vector2(108, 149)

[node name="drop_spot" type="Area2D"]
script = SubResource("GDScript_5g2wd")

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(54, 75)
shape = SubResource("RectangleShape2D_5g2wd")

[node name="Sprite2D" type="Sprite2D" parent="."]
position = Vector2(54, 75)
scale = Vector2(2.3, 2.3)
texture = ExtResource("1_mwg88")

[node name="Sprite2D2" type="Sprite2D" parent="."]
position = Vector2(54, -75)
scale = Vector2(2.26744, 2.26744)
texture = ExtResource("1_mwg88")

[node name="highlight" type="Sprite2D" parent="."]
visible = false
position = Vector2(54, 75)
scale = Vector2(2.3, 2.3)
texture = ExtResource("2_lx47d")

[connection signal="mouse_entered" from="." to="." method="_on_mouse_entered"]
